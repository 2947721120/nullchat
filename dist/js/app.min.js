/*! Xtendify JS (Copyright) */
var ver="1.2.6";document.getElementById("notification").volume=.4,function(){"use strict";angular.module("nullchat",["ngMaterial","firebase","ui.router","luegg.directives","ngHolder","angularMoment","ngSanitize","ngFileUpload","angulartics","angulartics.google.analytics"]).run(["$rootScope","$mdSidenav",function(a,b){a.$on("$stateChangeSuccess",function(a,c,d,e,f){"chat"==c.name&&!b("left").isLockedOpen()&&b("left").isOpen()&&b("left").close()})}]).config(["$mdThemingProvider","$mdIconProvider","$urlRouterProvider","$stateProvider","$analyticsProvider",function(a,b,c,d,e){function f(a){return a.init()}f.$inject=["NCService"],c.otherwise("/"),d.state("dashboard",{url:"/",templateUrl:"views/dashboard.html",resolve:{loadApp:f}}).state("chat",{url:"/:chatId",templateUrl:"views/chatbox.html",controller:"ChatBoxController",controllerAs:"cb",resolve:{loadApp:f,chatValid:["NCService","$stateParams","$rootScope",function(a,b,c){return c.loadingActivity=!0,a.loadChatData(b.chatId)}]}}),b.defaultIconSet("./assets/svg/avatars.svg",128).icon("menu","./assets/svg/menu.svg",24).icon("share","./assets/svg/share.svg",24).icon("google_plus","./assets/svg/google_plus.svg",512).icon("hangouts","./assets/svg/hangouts.svg",512).icon("twitter","./assets/svg/twitter.svg",512).icon("phone","./assets/svg/phone.svg",512),a.theme("default").primaryPalette("blue").accentPalette("teal"),e.firstPageview(!0),e.withAutoBase(!0)}]).directive("execOnScrollToTop",["$timeout",function(a){return{restrict:"A",link:function(b,c,d){var e=angular.element(c),f=b.$eval(d.execOnScrollToTop);e.bind("scroll",function(d){if(d.target.scrollTop<=0){console.log("doing it...");var e=b.$apply(f);if(e){b.scrollLoading=!0;var g=c[0].scrollHeight,h=b.$watch(function(){return c[0].scrollHeight},function(b,d,e){b!=d&&(c[0].scrollTop=c[0].scrollHeight-g,h(),a(function(){e.scrollLoading=!1}))})}}})}}}])}(),function(){function a(a,b,c,d,e,f,g,h,i){function j(b){return a.isChatLoaded(b)}function k(){var a=0;angular.forEach(e.chats,function(b,c){a+=e.chats[c].unreadCount});var b="InstantChat.io";return a>0&&(b="("+a+") "+b),d.trustAsHtml(b)}function l(){g("left").toggle()}function m(a){i.show({targetEvent:a,templateUrl:"views/nameDialog.html",clickOutsideToClose:!0,preserveScope:!0,bindToController:!0,controller:"UserNameChangeController",controllerAs:"nc"})}function n(){a.createChat()}function o(){return a.getChatList()}function p(){return a.getUser().name}function q(b){return h.chatId===b?null:a.newMessageCount(b)}function r(b){return a.getChat(b)?a.getChat(b).meta.name:b}var s=this;s.getUserName=p,s.toggleList=l,s.createChat=n,s.getChatList=o,s.newMessageCount=q,s.showNameDialog=m,s.showTotalUnreadCount=k,s.chatLoaded=j,s.getChatName=r;var t=new f.Idle;t.onAway=function(){h.chatId&&a.setUserIdle(!0,h.chatId)},t.onAwayBack=function(){h.chatId&&(a.resetUnreadCount(h.chatId),a.setUserIdle(!1,h.chatId))},t.setAwayTimeout(5e3),t.start()}function b(a,b,c){function d(){}function e(){b.cancel()}function f(){a.changeUserName(i.userName),b.cancel()}function g(){a.logoutUser().then(function(){a.goHome(),b.cancel()})}function h(b){a.authUser(b).then(function(){a.goHome(),i.closeDialog()},function(){alert("Login Failed!"),i.closeDialog()})}var i=this;i.userName=a.getUser().name,i.closeDialog=e,i.changeUserName=f,i.authUser=h,i.authState=a.getAuthState("google"),i.logoutUser=g,i.showProfileImage=a.getUserSettings("showProfileImage"),i.saveSettings=d,console.log(i.authState)}function c(a,b,c){function d(){a.changeChatName(f.chatId,f.chatName),f.closeDialog()}function e(){c.hide()}var f=this;f.chatId=b.chatId,f.chatName=a.getChat(f.chatId).meta.name,console.log(this),f.closeDialog=e,f.changeChatName=d}function d(a,b,c,d,e,f,g,h,i,j){function k(){return a.initChatData(B.chatId,!0)}function l(){return a.isChatOwner(B.chatId)}function m(a,b){B.menuOriginatorEv=b,a(b)}function n(){c.show({targetEvent:B.menuOriginatorEv,clickOutsideToClose:!0,preserveScope:!0,bindToController:!0,templateUrl:"views/chatDialog.html",controller:"ChatDialogController",controllerAs:"cd"})}function o(b){a.resetUnreadCount(B.chatId)}function p(){document.getElementById("chatText").blur()}function q(b){b&&(B.uploadProgress=10,a.uploadFile(b).then(function(b){console.log(b.data),b.data&&b.data.data&&b.data.data.link&&a.appendArray(B.chatId,"image",b.data.data.link),B.uploadProgress=0},function(a){console.log(a),alert("image upload failed"),B.uploadProgress=0},function(a){B.uploadProgress=parseInt(100*a.loaded/a.total)}))}function r(a){if(!a)return a;if("function"==typeof URL){var b=new URL(a).hostname;if("i.imgur.com"===b){var c=a.replace("http://","https://");return c=c.replace(/\.(jpg|png|gif|jpeg)$/i,"m.$1")}return a}return a}function s(){alert=c.alert({title:"分享",textContent:i.absUrl(),ok:"确定"}),c.show(alert)["finally"](function(){})}function t(a){return void 0===B.userBgColors[a]&&(B.userBgColors[a]=B.holderThemes.shift(),B.holderThemes.push(B.userBgColors[a])),B.userBgColors[a]}function u(){a.leaveChat(B.chatId)}function v(){B.chatText&&(a.appendArray(B.chatId,"text",B.chatText),B.chatText="",B.changeTypingStatus(B.chatId,"remove"))}function w(a){var b=this;13!=a.keyCode||a.shiftKey||(b.sendChat(),a.preventDefault())}function x(){return a.getChatData(B.chatId)}function y(b){return a.showOwner(B.chatId,b)}function z(){var b="add";B.chatText||(b="remove"),a.changeTypingStatus(B.chatId,b)}function A(){return a.showTypingStatus(B.chatId)}var B=this;B.chatId=d.chatId,B.uploadProgress=0,0==g&&(a.leaveChat(B.chatId),h.transitionTo("dashboard")),e.loadingActivity=!1,B.chatValid=g,B.sendChat=v,B.getChatData=x,B.showOwner=y,B.changeTypingStatus=z,B.showTypingStatus=A,B.genUserBg=t,B.leaveChat=u,B.showShareModal=s,B.resetUnreadCount=o,B.removeFocus=p,B.uploadFile=q,B.handleKeyDown=w,B.openChatMenu=m,B.renameChat=n,B.isChatOwner=l,B.imageSrc=r,B.handleScrollToTop=k,B.holderThemes=["sky","vine","lava","industrial","social"],B.userBgColors={},B.menuOriginatorEv=null}angular.module("nullchat").controller("NCController",a).controller("UserNameChangeController",b).controller("ChatDialogController",c).controller("ChatBoxController",d),a.$inject=["NCService","$q","$scope","$sce","$rootScope","$window","$mdSidenav","$stateParams","$mdDialog"],b.$inject=["NCService","$mdDialog","$rootScope"],c.$inject=["NCService","$stateParams","$mdDialog"],d.$inject=["NCService","$timeout","$mdDialog","$stateParams","$rootScope","$q","chatValid","$state","$location","$window"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j){var k={INIT:0,RUNNING:1,LOADED:2};return{syncObject:{user:null,users:{},chats:{}},uid:0,fbRef:null,authObj:null,chats:[],fbData:null,metaUsers:{},userIdle:!1,makeid:function(a){for(var b="",c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",d=0;a>d;d++)b+=c.charAt(Math.floor(Math.random()*c.length));return b},initRootScope:function(){f.users={},f.chats={}},authAnonymous:function(a){var b=this;b.fbRef.authAnonymously(a)},init:function(b){var c=this,d=a.defer();return void 0===f.currentState&&(c.initRootScope(),f.loadingActivity=!0,f.currentState=k.INIT),f.currentState==k.LOADED&&d.resolve(c.fbRef),f.currentState==k.INIT&&(f.currentState=k.RUNNING,c.fbRef=new Firebase("https://angular-cn.firebaseio.com/79/"),c.authObj=e(c.fbRef),c.authObj.$onAuth(function(a){if(console.log("login changed"),console.log(a),a){if(c.syncObject.user&&c.syncObject.user.$value&&c.syncObject.user.$destroy(),Object.keys(f.chats).length)for(var b in f.chats)c.syncObject.chats[b]&&c.syncObject.chats[b].$value&&c.syncObject.chats[b].$destroy();c.uid=a.uid,c.initData().then(function(){"google"===a.provider&&(f.user.auth=a.auth),d.resolve(c.fbRef)})}else console.log("Login changed and no uid anymore")}),c.authObj.$waitForAuth().then(function(a){if(a&&a.expires)var b=new Date,d=b.getTime(),e=(1e3*a.expires,(1e3*a.expires-d)/6e4);(!a||0>e)&&c.authAnonymous(function(a,b){a?console.log("Login Failed! DIE!!!",a):console.log("Authenticated successfully with payload:",b)})})),d.promise},changeUserName:function(a){a=a.trim(),a&&您!=a.toUpperCase()&&"ADMIN"!=a.toUpperCase()&&-1===a.toUpperCase().indexOf("FUCK")&&(f.user.meta.name=a)},initStructUser:function(){var a=this;void 0===f.user.meta&&(f.user.meta={},a.changeUserName("用户 "+a.makeid(5))),void 0===f.user.auth&&(f.user.auth={}),void 0===f.user.settings&&(f.user.settings={}),void 0===f.user.chats&&(f.user.chats={own:[],shared:[]})},initData:function(){var b=this,c=a.defer();return console.log(b.uid),b.syncObject.user&&b.syncObject.user.$value&&b.syncObject.user.$destroy(),b.syncObject.user=d(b.fbRef.child("users").child(b.uid)),b.syncObject.user.$bindTo(f,"user"),b.syncObject.user.$loaded(function(a){console.log("user loaded "+b.uid),b.initStructUser(),f.loadingActivity=!1,f.currentState=k.LOADED,c.resolve(b.fbRef)}),c.promise},isNcdataInit:function(){return void 0!==f.user},initStructChat:function(a){},getUser:function(){var a=this;return a.isNcdataInit()?{name:f.user.meta.name}:{name:""}},createChat:function(){var a=this,c=this.makeid(10);void 0===f.user.chats.own&&(f.user.chats.own=[]),f.user.chats.own.push(c);var d={meta:{name:c,created:Firebase.ServerValue.TIMESTAMP,owner:a.uid},data:{desc:"Chat Data",sharedWith:[],typing:[]},array:[]};a.fbRef.child("chats").child(c).set(d,function(){b.eventTrack("chat-create",{category:"chat",label:c}),h.transitionTo("chat",{chatId:c})})},getChatList:function(){var a=this;return a.isNcdataInit()?f.user.chats:[]},showOwner:function(a,b){var c=this;return c.uid==b?"You":void 0!==f.users[b]?f.users[b].name:void c.loadUserInfo(a)},getCurTimestamp:function(){var a=new Date;return a.getTime()},changeTypingStatus:function(a,b){var c=this;null!==f.chats[a].data.$value&&c.isNcdataInit()&&((void 0===f.chats[a].data.typing||Array.isArray(f.chats[a].data.typing))&&(f.chats[a].data.typing={}),void 0!==f.chats[a].data.typing[c.uid]&&f.chats[a].data.typing[c.uid]!==!1||"add"!=b||(f.chats[a].data.typing[c.uid]=c.getCurTimestamp()),void 0!==f.chats[a].data.typing[c.uid]&&"remove"==b&&(f.chats[a].data.typing[c.uid]=!1))},showTypingStatus:function(a){var b=this;return b.isNcdataInit()&&void 0!==f.chats[a].data.typing?Object.keys(f.chats[a].data.typing).length>0?(b.typing=[],angular.forEach(f.chats[a].data.typing,function(c,d){d!==b.uid&&b.getCurTimestamp()-c<1e4&&b.showOwner(a,d)&&b.typing.push(b.showOwner(a,d))}),b.typing.length>1?b.typing=b.typing.join(", ")+" are typing":1==b.typing.length?b.typing=b.typing[0]+" is typing":b.typing="",b.typing):"":void 0},addUserToChat:function(a){var b=this,c=!1;return f.chats[a].meta.owner!==b.uid&&(void 0===f.user.chats.shared&&(f.user.chats.shared=[]),-1==f.user.chats.shared.indexOf(a)&&(c=!0,f.user.chats.shared.push(a))),void 0===f.chats[a].data.sharedWith&&(f.chats[a].data.sharedWith={}),f.chats[a].data.sharedWith[b.uid]=!0,c},isInit:function(){var b=a.defer(),c=f.$watch("currentState",function(a){a==k.LOADED&&(c(),b.resolve())});return b.promise},destroyAFObj:function(a){a&&a.$id&&a.$destroy()},initRootObj:function(a,b){void 0===a[b]&&(a[b]={})},loadUserInfo:function(a){var b=this,c=f.chats[a].data.sharedWith;angular.forEach(c,function(a,c){void 0===f.users[c]&&(f.users[c]={name:".."},b.syncObject.users[c]=d(b.fbRef.child("users").child(c).child("meta")),b.syncObject.users[c].$bindTo(f,"users['"+c+"']"),b.syncObject.users[c].$loaded(function(a){}))})},isChatLoaded:function(a){var b=this;return b.isNcdataInit()?void 0!==f.chats[a]&&void 0!==f.chats[a].meta&&void 0!==f.chats[a].data:!1},newMessageCount:function(a){return void 0!==f.chats[a]&&void 0!==f.chats[a].unreadCount?f.chats[a].unreadCount:""},freeChatMem:function(a){var b=this;b.syncObject.chats[a].data.$destroy(),b.syncObject.chats[a].meta.$destroy(),f.chats[a].array.$destroy()},leaveChat:function(a){var b=this,c=!1;return void 0===f.chats[a].meta?(i.show(i.simple().position("top right").textContent("Chat not found")),void(-1!=f.user.chats.own.indexOf(a)&&f.user.chats.own.splice(f.user.chats.own.indexOf(a),1))):(c=f.chats[a].meta.owner===b.uid,void(c?(console.log("you are the owner of this chat"),b.fbRef.child("chats").child(a).remove(function(){console.log("deleted"),b.freeChatMem(a),-1!=f.user.chats.own.indexOf(a)&&f.user.chats.own.splice(f.user.chats.own.indexOf(a),1),i.show(i.simple().position("top right").textContent("Chat disposed!")),h.transitionTo("dashboard")})):(void 0!==f.chats[a].data.sharedWith&&void 0!==f.chats[a].data.sharedWith[b.uid]&&delete f.chats[a].data.sharedWith[b.uid],-1!=f.user.chats.shared.indexOf(a)&&(b.appendArray(a,"status","left").then(function(){b.freeChatMem(a)}),f.user.chats.shared.splice(f.user.chats.shared.indexOf(a),1)),i.show(i.simple().position("top right").textContent("你不再是这个聊天的一部分")),h.transitionTo("dashboard"))))},playNotification:function(){document.getElementById("notification").play()},resetUnreadCount:function(a){f.chats[a].unreadCount=0},goHome:function(){h.transitionTo("dashboard")},setUserIdle:function(a,b){var c=this;c.userIdle=a},initChatData:function(a,b){var d=this,e=200;if(b){var h=d.syncObject.chats[a].arrayRef.scroll.hasNext();h&&d.syncObject.chats[a].arrayRef.scroll.next(e)}else{var i=d.addUserToChat(a);d.syncObject.chats[a].arrayRef=new Firebase.util.Scroll(d.fbRef.child("chats").child(a).child("array"),"invertedTimestamp"),f.chats[a].array=c(d.syncObject.chats[a].arrayRef),d.syncObject.chats[a].arrayRef.scroll.next(e);var h=d.syncObject.chats[a].arrayRef.scroll.hasNext();f.chats[a].array.$loaded(function(){i&&d.appendArray(a,"status","加入"),f.chats[a].array.$watch(function(b,c){if("child_added"===b.event&&void 0!==g.chatId&&(g.chatId!==a||1==d.userIdle)){var e=f.chats[a].array.$getRecord(b.key);1==d.userIdle&&e.type&&"status"!==e.type&&d.playNotification(),f.chats[a].unreadCount+=1}})})}return h},loadChatData:function(b){var c=this,e=a.defer();return void 0!==f.chats[b]&&void 0!==f.chats[b].data?(f.chats[b].unreadCount=0,e.resolve(!0),e.promise):(c.initRootObj(c.syncObject.chats,b),c.initRootObj(f.chats,b),f.chats[b].unreadCount=0,c.syncObject.chats[b].data=d(c.fbRef.child("chats").child(b).child("data")),c.syncObject.chats[b].data.$bindTo(f,"chats['"+b+"'].data"),c.syncObject.chats[b].data.$loaded(function(a){console.log("chat data loaded"),void 0!==f.chats[b].data.desc?(c.syncObject.chats[b].meta=d(c.fbRef.child("chats").child(b).child("meta")),c.syncObject.chats[b].meta.$bindTo(f,"chats['"+b+"'].meta"),c.syncObject.chats[b].meta.$loaded(function(a){console.log("chat meta loaded"),c.initChatData(b,!1),e.resolve(!0)})):(console.log("Invalid Chat Id"),e.resolve(!1))}),e.promise)},changeChatName:function(a,b){var c=this;a&&c.isChatLoaded(a)&&(f.chats[a].meta.name=b)},isChatOwner:function(a){var b=this;return b.isNcdataInit()&&b.isChatLoaded(a)&&f.chats[a].meta.owner?f.chats[a].meta.owner===b.uid:!1},getChat:function(a){var b=this;return b.isNcdataInit()&&b.isChatLoaded(a)?f.chats[a]:!1},getChatData:function(a){var b=this;return b.isNcdataInit()&&b.isChatLoaded(a)?f.chats[a].array:[]},appendArray:function(c,d,e){var g=this,h=a.defer();if(null===f.chats[c].data.$value)return g.leaveChat(c),h.reject(),h.promise;if(e){var i=new Date,j=0-(i.getTime()+60*i.getTimezoneOffset()*1e3);return b.eventTrack("message-send",{category:"message",label:d}),f.chats[c].array.$add({text:e,timestamp:Firebase.ServerValue.TIMESTAMP,author:g.uid,type:d,invertedTimestamp:j})}},getUserSettings:function(a){var b=this;return b.isNcdataInit()&&f.user.settings?f.user.settings[a]:!1},setUserSettings:function(a,b){var c=this;c.isNcdataInit()&&(void 0===f.user.settings&&(f.user.settings={}),f.user.settings[a]=b)},getAuthState:function(a){var b=this,c=b.authObj.$getAuth();return c?c.provider==a:!1},logoutUser:function(){var b=this,c=a.defer();return b.authObj.$unauth(),b.authAnonymous(function(){c.resolve()}),c.promise},authUser:function(b){console.log("login");var c=this,d=a.defer();return c.fbRef.authWithOAuthPopup("google",function(a,b){a?(console.log("Login Failed!",a),d.reject()):(console.log("Authenticated successfully with payload:",b),d.resolve())}),d.promise},uploadFile:function(a){return console.log(a),j.http({url:"https://api.imgur.com/3/image",headers:{"Content-Type":a.type?a.type:"application/octet-stream",Authorization:"Client-ID 738ec210e1fa4b8"},data:a})}}}angular.module("nullchat").service("NCService",a),a.$inject=["$q","$analytics","$firebaseArray","$firebaseObject","$firebaseAuth","$rootScope","$stateParams","$state","$mdToast","Upload"]}(),function(){angular.module("nullchat").filter("showFirstChar",function(){return function(a){return a&&a.length>1?a[0]:a}}).filter("fromNow",function(){return function(a){return moment(a).fromNow()}}).filter("nl2br",function(){return function(a){return a.replace(/&#10;/g,"<br/>")}})}();
//# sourceMappingURL=app.min.js.map